name: Build and Release

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v0.1.0)'
        required: false
        default: ''
  
  # æ¨é€ tag æ—¶è§¦å‘
  push:
    tags:
      - 'v*.*.*'
  
  # PR æ—¶åªæ„å»ºä¸å‘å¸ƒï¼ˆæµ‹è¯•æ„å»ºæ˜¯å¦æˆåŠŸï¼‰
  pull_request:
    branches: [main]

# æƒé™é…ç½®
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release
  packages: read

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -e .
      
      - name: Build executable
        run: |
          pyinstaller --clean winstyles.spec
      
      - name: Verify build output
        run: |
          if (Test-Path "dist/WinstyleS.exe") {
            Write-Host "âœ“ Build successful: dist/WinstyleS.exe"
            Get-Item "dist/WinstyleS.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Host "âœ— Build failed: executable not found"
            exit 1
          }
      
      - name: Create ZIP archive
        run: |
          Compress-Archive -Path "dist/WinstyleS.exe" -DestinationPath "dist/WinstyleS-Windows-x64.zip"
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WinstyleS-Windows-x64
          path: dist/WinstyleS.exe
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    # åªåœ¨ tag æ¨é€æˆ–æ‰‹åŠ¨è§¦å‘æ—¶åˆ›å»º release
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: WinstyleS-Windows-x64
          path: dist
      
      - name: Create ZIP for release
        run: |
          cd dist
          zip WinstyleS-Windows-x64.zip WinstyleS.exe
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.release_version }}" ]; then
            echo "version=${{ github.event.inputs.release_version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: WinstyleS ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          generate_release_notes: true
          files: |
            dist/WinstyleS-Windows-x64.zip
          body: |
            ## ğŸ‰ WinstyleS ${{ steps.version.outputs.version }}
            
            Windows Style Sync - è‡ªåŠ¨æ‰«æã€å¯¼å‡ºã€åŒæ­¥ä½ çš„ Windows ç¾åŒ–é…ç½®ã€‚
            
            ### ğŸ“¦ ä¸‹è½½
            
            | å¹³å° | ä¸‹è½½ |
            |------|------|
            | Windows x64 | [WinstyleS-Windows-x64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/WinstyleS-Windows-x64.zip) |
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            
            1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
            2. åŒå‡» `WinstyleS.exe` è¿è¡Œ
            3. æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ Web ç•Œé¢
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            
            - é¦–æ¬¡è¿è¡Œå¯èƒ½è¢« Windows Defender æ‹¦æˆªï¼Œè¯·é€‰æ‹©"ä»è¦è¿è¡Œ"
            - åº”ç”¨éœ€è¦ç®¡ç†å‘˜æƒé™æ¥è¯»å–æŸäº›ç³»ç»Ÿé…ç½®
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
